<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<!--
    @author Robin Duda
    Realm chat.
 -->

<dom-module id="friend-view">
    <link rel="import" href="../../style/theme.css" type="css">
    <link rel="import" href="../../style/style.css" type="css">
    <template>
        <style>
            :host {
            }

            #dialog {
                width: 624px;
                min-width: 428px;
                max-width: 624px;
                min-height: 376px;
                max-height: 376px;
            }

            span {
                padding: 0.28rem;
            }

            ::-webkit-scrollbar {
                width: 6px;
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: var(--accent-color);
                opacity: 0.76;
            }

            ::-webkit-scrollbar-track {
                -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
            }

            .friend-item {
                padding: 6px;
                font-size: small;
                display: flex;
                justify-content: space-between;
            }


            #friends {
                width: 192px;
                overflow-y: scroll;
                position: absolute;
                bottom: 0px;
                top: 52px;
            }

            .add-icon {
                top: 26px;
                right: 8px;
            }

            .add-area {
                position: absolute;
                left: 198px;
                right: 8px;
                bottom: 0px;
                top: 54px;
            }

            .add-controls {
                display: flex;
                flex-direction: row;
                justify-content: center;
            }

            .suggestion-title {
                text-align: center;
                display: block;
            }

            .add-input {
                width: 100%;
            }

            .message {
                width: 60%;
                padding: 8px;
                margin: 4px;
                font-size: smaller;
            }

            .sender {
                display: block;
                font-size: x-small;
                text-align: right;
                padding: 0;
            }

            .to {
                margin-left: 34%;
            }

            .suggestions {
                margin-top: 8px;
            }

            .actions {
                position: absolute;
                display: flex;
                flex-direction: row;
                right: 8px;
                top: 6px;
            }

            .action-icon {

            }

            .close-chat {
                top: 22px;
            }

            .send-icon {
                display: block;
                margin-top: 24px;
            }

            #message {
                width: 100%;
            }

            #messages {
                overflow-y: scroll;
                overflow-x: hidden;
                word-break: break-word;
                position: absolute;
                top: 0px;
                bottom: 48px;
                right: 8px;
                left: 0px;
            }

            #message-send {
                position: absolute;
                bottom: -4px;
                right: 8px;
                left: 0px;
            }

            #send-controls {
                display: flex;
            }

        </style>

        <div class="dialog-container" id="container">
            <div class="dialog-overlay"></div>

            <paper-material elevation="3" class="interface-box noselect dialog-center" id="dialog">
                <iron-icon icon="icons:close" id="dialog-close" on-down="_hide"></iron-icon>

                <span class="dialog-entity">Friends</span>

                <hr>
                <div id="friends">

                    <template is="dom-if" if="[[_hasFriends(list)]]">
                        <template is="dom-repeat" items="[[_friendList(unread, friends, online)]]" as="friend">
                            <paper-material on-tap="_chat" class="friend-item" elevation="0"
                                            style$="background-color:[[_highlight(friend, chat)]];
                                                    color:[[_locality(friend, online)]];
                                                    [[_index(index)]]">
                                <span class="friend-name">[[friend]]</span>

                                <template is="dom-if" if="[[_online(friend, online, unread)]]">
                                    <paper-ripple></paper-ripple>
                                    <span class="thread-unread">[[_unread(friend, unread)]]</span>
                                </template>

                                <paper-tooltip animation-delay="0" class="tooltip">
                                    [[_description(friend, online)]]
                                </paper-tooltip>
                            </paper-material>
                        </template>
                        <hr>
                    </template>

                    <template is="dom-if" if="[[_hasRequests(requests)]]">
                        <span>Incoming</span>

                        <template is="dom-repeat" items="[[requests]]" as="request">
                            <paper-material class="friend-item" elevation="0">

                                <span class="friend-name">[[request]]</span>

                                <div class="actions">
                                    <iron-icon icon="icons:check" class="action-icon" on-tap="_accept"></iron-icon>
                                    <iron-icon icon="icons:close" class="action-icon" on-tap="_reject"></iron-icon>
                                </div>

                                <paper-ripple></paper-ripple>
                            </paper-material>
                        </template>

                        <hr>
                    </template>

                    <template is="dom-if" if="[[_hasPending(pending)]]">
                        <span>Pending</span>

                        <template is="dom-repeat" items="[[pending]]" as="pendant">
                            <paper-material class="friend-item" elevation="0">

                                <span class="friend-name">[[pendant]]</span>
                                <div class="actions">
                                    <!-- no support for canceling requests yet. -->
                                    <!--<iron-icon icon="icons:close" class="action-icon" on-tap="_cancel"></iron-icon>-->
                                </div>

                                <paper-ripple></paper-ripple>
                            </paper-material>
                        </template>
                    </template>
                </div>

                <div class="add-area">

                    <template is="dom-if" if="[[!_isChat(chat)]]">
                        <div class="add-controls">
                            <paper-input value="{{friend}}" id="friend" label="Add Friend" on-input="_requestSuggested"
                                         on-keydown="_keydown"
                                         type="text" class="add-input" always-float-label autofocus></paper-input>

                            <iron-icon icon="icons:add" class="add-icon" on-tap="_request"></iron-icon>
                        </div>

                        <template is="dom-if" if="[[_hasSuggestions(suggestions)]]">
                            <div class="suggestions">
                                <span class="suggestion-title">Suggestions</span>
                                <template is="dom-repeat" items="[[suggestions]]" as="suggestion">
                                    <paper-material class="friend-item" elevation="0" on-down="_requestFromSuggested">
                                        <span class="friend-name">[[suggestion]]</span>
                                        <paper-ripple></paper-ripple>
                                    </paper-material>
                                </template>
                            </div>
                        </template>
                    </template>


                    <template is="dom-if" if="[[_isChat(chat)]]">
                        <div id="messages">
                            <template is="dom-repeat" items="[[thread]]" as="message">
                                <div class$="message border [[_direction(message)]]">
                                    <span class="sender">[[message.from]]</span>
                                    [[message.message]]
                                </div>
                            </template>
                        </div>

                        <div id="message-send">
                            <div id="send-controls">
                                <iron-icon icon="icons:reply" class="close-chat" on-tap="_findFriends"></iron-icon>
                                <paper-input value="{{message}}" id="message" label="Message"
                                             on-keydown="_sendMessage"
                                             type="text" class="add-input" always-float-label autofocus></paper-input>

                                <iron-icon icon="icons:send" class="send-icon" on-tap="_message"></iron-icon>
                            </div>
                        </div>
                    </template>

                </div>
            </paper-material>
        </div>
    </template>
    <script>
        class FriendView extends Polymer.GestureEventListeners(Polymer.Element) {

            static get is() {
                return 'friend-view';
            }

            constructor() {
                super();
                this.chat = false;
                this.list = [];
                this.pending = [];
                this.requests = [];
                this.suggestions = [];
                this.online = {};
                this.messages = {};
                this.thread = [];
                this.unread = {};
            }

            ready() {
                super.ready();

                application.onGameLoaded(() => {
                    input.onKeysListener({
                        down: () => {
                            application.publish('show-friends');
                        }
                    }, 'j');

                    this._listen();
                });

                application.subscribe('show-friends', () => {
                    if (this._open()) {
                        this._hide();
                    } else {
                        this._pending();
                        this._list();

                        this.suggestions = [];
                        this.friend = '';

                        this._show();
                    }
                });
            }

            _friendList() {
                return this.list;
            }

            _unread(friend) {
                this.unread[friend] = this.unread[friend] || 0;
                let unread = this.unread[friend];
                return (unread > 0) ? unread : '';
            }

            _listen() {
                server.connection.setHandler('friend_message', event => {
                    if (!this.messages[event.from]) {
                        this.messages[event.from] = [];
                    }

                    this.messages[event.from].push(event);

                    if (this.chat !== event.from) {
                        this.set(`unread.${event.from}`, (this.unread[event.from] || 0) + 1);
                        this.notifyPath('unread', Object.assign({}, this.unread));
                    } else {
                        this.notifySplices('thread');
                        this._scroll();
                    }

                    if (!this._open()) {
                        game.chat.add({text: `${event.from}: ${event.message}`, private: true});
                    }
                });

                server.connection.setHandler('social_offline', event => {
                    this.online[event.friend] = this.online[event.friend] || [];
                    this.online[event.friend] = this.online[event.friend]
                        .filter(function (value, index, arr) {
                            return value !== event.realm;
                        });
                    this.notifyPath(`online`, Object.assign({}, this.online));
                });

                server.connection.setHandler('social_online', event => {
                    application.publish('notification', `${event.friend} is now online.`);
                    this.online[event.friend] = this.online[event.friend] || [];
                    this.online[event.friend].push(event.realm);
                    this.notifyPath(`online`, Object.assign({}, this.online));
                });
            }

            _locality(friend) {
                let realms = this.online[friend];
                if (realms && realms.length > 0) {
                    return (realms.includes(application.realm.node)) ? 'lime' : 'orange';
                } else {
                    return 'red';
                }
            }

            _description(friend) {
                let realms = this.online[friend];
                if (realms && realms.length > 0) {
                    return (realms.includes(application.realm.node)) ? application.realm.node : realms[0];
                } else {
                    return "Offline";
                }
            }

            _index(index) {
                return `z-index: ${500 - index};`;
            }

            _findFriends() {
                this.chat = false;
            }

            _direction(message) {
                return (message.from === application.token.domain) ? 'from' : 'to';
            }

            _online(friend) {
                return (this.online[friend]);
            }

            _chat(e) {
                if (this._online(e.model.friend)) {
                    this.chat = e.model.friend;
                    this.unread[this.chat] = 0;
                    this.notifyPath('unread', Object.assign({}, this.unread));

                    if (!this.messages[this.chat]) {
                        this.messages[this.chat] = [];
                    }
                    this.thread = this.messages[this.chat];
                    this.notifySplices('thread', this.thread.splice());
                    this._scroll();
                }
            }

            _scroll() {
                setTimeout(() => {
                    try {
                        let element = this.shadowRoot.querySelector('#messages');
                        element.scrollTop = element.scrollHeight;
                    } catch (e) {
                        // do nothing.
                    }
                }, 1);
            }

            _isChat(friend) {
                return !!friend;
            }

            _highlight(friend) {
                let color = getComputedStyle(this).getPropertyValue('--accent-color') + '40';
                return (friend === this.chat) ? color : '';
            }

            _list() {
                social.friend_list(event => {
                    this.list = event.friends;
                    this.requests = event.requests;
                    this.online = event.online;
                });
            }

            _selected() {
                return "";
            }

            _pending() {
                social.friend_pending(event => {
                    this.pending = event.pending;
                    this.notifyPath('pending');
                });
            }

            _accept(e) {
                social.friend_accept(event => {
                    this.list = event.friends;
                    this.requests = event.requests;
                    this._pending();
                }, e.model.request);
            }

            _hasRequests() {
                return this.requests.length > 0;
            }

            _hasPending() {
                return this.pending.length > 0;
            }

            _hasFriends() {
                return this.list.length > 0;
            }

            _hasSuggestions() {
                return this.suggestions.length > 0;
            }

            _reject(e) {
                social.friend_reject(event => {
                    this._list();
                }, e.model.request);
            }

            _keydown(e) {
                if (e.keyCode === 13) {
                    this._request();
                }
            }

            _requestSuggested(event) {
                if (this.friend.length >= 1) {
                    social.friend_suggestion(event => {
                        this.suggestions = event.suggestions;
                        this.notifyPath("suggestions");
                    }, this.friend);
                } else {
                    this.suggestions = [];
                }
            }

            _requestFromSuggested(e) {
                this._sendRequest(e.model.suggestion);
                this.suggestions = [];
                this.notifyPath("suggestions");
                this.friend = "";
            }

            _request() {
                if (this.friend.length > 0) {
                    this._sendRequest(this.friend);
                    this.friend = "";
                }
            }

            _sendRequest(target) {
                social.friend_request(event => {
                    application.publish('notification', `Friend request sent to ${target}.`);
                    this._pending();
                }, target);
            }

            _preview() {
                // list accounts to add.. min 3 chars - 5 samples sorted.
            }

            _open() {
                return this.$.container.style.display === 'block';
            }

            _show() {
                input.block();
                this.$.container.style.display = 'block';
            }

            _hide() {
                input.unblock();
                this.$.container.style.display = 'none';
            }

            _message() {
                if (this.message.length > 0) {
                    social.friend_message((e) => {
                        this.thread.push({
                            message: this.message,
                            from: application.token.domain,
                            to: this.chat
                        });
                        this.message = '';
                        this.notifySplices('thread');
                        this._scroll();
                    }, this.chat, this.message);
                }
            }

            _sendMessage(e) {
                if (e.keyCode === 13) {
                    this._message();
                }
            }
        }

        window.customElements.define(FriendView.is, FriendView);
    </script>
</dom-module>