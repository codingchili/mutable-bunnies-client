<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../stats-view.html">

<!--
    @author Robin Duda
    Realm chat.
 -->

<dom-module id="player-status">
    <link rel="import" href="../../style/theme.css" type="css">
    <link rel="import" href="../../style/style.css" type="css">
    <template>
        <style>
            :host {
                position: absolute;
                left: 16px;
                top: 16px;
                width: 416px;
                z-index: 800;
            }

            .frame {
                display: block;
                height: 68px;
                z-index: 495;
            }

            .portrait {
                height: 42px;
                margin-top: 4px;
                margin-left: 10px;
            }

            .name {
                display: block;
                position: absolute;
                left: 66px;
                opacity: 0.86;
                top: 12px;
            }

            .health-bar {
                margin-left: 64px;
                margin-right: 8px;
                margin-top: 32px;
                padding: 4px;
                --paper-progress-active-color: #8c0006;
                --paper-progress-container-color: #8c000632;
            }

            .energy-bar {
                top: 32px;
                left: 64px;
                margin-left: 64px;
                margin-right: 8px;
                margin-top: 4px;
                padding: 4px;
                --paper-progress-active-color: #4db6ac;
                --paper-progress-container-color: #4db6ac32;
            }

            .level {
                display: block;
                position: absolute;
                top: 4px;
                right: 14px;
                width: 48px;
                text-align: right;
                font-size: larger;
            }

            .exp-bar {
                width: 46px;
                margin-top: -11px;
                padding: 4px;
                margin-left: 6px;
                --paper-progress-active-color: #b6a500;
                --paper-progress-container-color: #b6a50032;
            }

            .health-bar > paper-progress {
                width: 100%;
            }

            .energy-bar > paper-progress {
                width: 100%;
            }

            .exp-bar > paper-progress {
                width: 100%;
            }

            .class-icon {
                position: absolute;
            }

            /* compact display classes ends with -mini. */
            .health-bar-mini {
                margin-top: 8px;
            }

            .portrait-mini {
                width: 24px;
                height: 24px;
                left: 8px;
                top: -2px;
                position: absolute;
            }

            .frame-mini {
                height: 40px;
                width: 276px;
            }

            .afflictions-mini {
                position: absolute;
                left: 222px;
                top: 0px;
            }

            .class-icon-mini {
                position: unset;
            }

            @media (max-width: 728px) {
                :host {
                    top: 0px;
                    left: 0px;
                    right: 0px;
                    width: unset;
                }

                .energy-bar {
                    width: 80%;
                }

                .health-bar {
                    width: 80%;
                }
            }

            #afflictions {
                margin-left: 62px;
                display: flex;
                flex-wrap: wrap;
                z-index: 850;
                flex-direction: row;
                width: 296px;
            }

            .affliction-icon {
                max-width: 24px;
                max-height: 24px;
            }

            @keyframes fadein {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .affliction {
                width: 24px;
                min-width: 24px;
                padding: 4px;
                height: 24px;
                margin: 4px;
                animation: fadein 0.72s ease 1;
            }

            .duration {
                color: #00b0ff;
            }

            .info-table {
                margin-top: 12px;
                width: 100%;
            }

            .title {
                font-size: 2.0em;
            }

            .description {
                margin-top: 12px;
                display: block;
                font-size: larger;
            }

            .class-stats {
                font-size: 14px;
                width: 176px;
            }

            .stats-tooltip {
                margin-left: 64px;
                z-index: 99999;
            }

            .class-stats {
                z-index: 999999;
            }

            img[src=""] {
                display: none;
            }

            .stats-level {
                display: block;
                right: 12px;
                position: absolute;
                top: 8px;
            }

            #stats {
                margin-top: 8px;
            }

            .spell-info {
                width: 192px;
            }

        </style>


        <paper-material elevation="3" id="frame" class="interface-box noselect frame">

            <slot></slot>

            <template is="dom-if" if="[[!compact]]">
                <span class="level">[[target.stats.level]]</span>
                <span class="name">[[target.name]]</span>
            </template>

            <div on-click="_target" class="class-icon" id="class-icon">
                <paper-tooltip animation-delay="0" position="bottom" class="stats-tooltip">
                    <div class="class-stats">
                        <span class="stats-header">[[target.name]]'s stats</span>
                        <span class="stats-level">lv. [[target.stats.level]]</span>
                        <stats-view id="stats" compact="true" selected="{{target}}"
                                    style="display:block"></stats-view>
                    </div>
                </paper-tooltip>
                <img id="portrait" class="portrait" src$="[[_portrait(target, realm)]]">
            </div>

            <div class="health-bar" id="health-bar">
                <paper-tooltip class="" animation-delay="0" position="bottom">
                    <span>[[_integer(target.stats.health)]] / [[_integer(target.stats.maxhealth)]]</span>
                </paper-tooltip>
                <paper-progress class="transiting" min="0" max="[[target.stats.maxhealth]]"
                                value="[[target.stats.health]]"></paper-progress>
            </div>

            <div class="energy-bar">
                <paper-tooltip class="" animation-delay="0" position="bottom">
                    <span>[[_integer(target.stats.energy)]] / [[_integer(target.stats.maxenergy)]]</span>
                </paper-tooltip>
                <paper-progress class="transiting" min="0" max="[[target.stats.maxenergy]]"
                                value="[[target.stats.energy]]"></paper-progress>
            </div>

            <div class="exp-bar">
                <paper-tooltip class="" animation-delay="0" position="bottom">
                    <span>[[_integer(target.stats.experience)]] / [[_integer(target.stats.nextlevel)]]</span>
                </paper-tooltip>
                <paper-progress class="transiting" min="0" max="[[target.stats.nextlevel]]"
                                value="[[target.stats.experience]]"></paper-progress>
            </div>

        </paper-material>

        <div id="afflictions">
            <template is="dom-repeat" items="{{afflictions}}" as="active">
                <div class="affliction interface-box">
                    <img src="[[realm.resources]]/gui/afflictions/[[active.affliction.id]].svg" class="affliction-icon"
                         alt="affliction">

                    <paper-tooltip class="spell-info" animation-delay="0" position="bottom">
                        <span class="title">[[active.affliction.name]]</span>

                        <table class="info-table">
                            <tr>
                                <th>Duration</th>
                            </tr>
                            <tr style="text-align: center;">
                                <td class="duration">[[active.duration]]s</td>
                            </tr>
                        </table>

                        <span class="description">{{_description(active.affliction)}}</span>
                    </paper-tooltip>
                </div>
            </template>
        </div>

    </template>
    <script>
        class PlayerStatus extends Polymer.MutableData(Polymer.Element) {

            static get is() {
                return 'player-status';
            }

            static get properties() {
                return {
                    compact: {
                        type: Boolean,
                        value: false
                    },
                    target: {
                        type: Object,
                        notify: true,
                        observer: '_notifyTargetChange'
                    }
                }
            }

            constructor() {
                super();
                this.afflictions = [];
                this.compact = false;
                this.target = {};
            }

            ready() {
                super.ready();

                setInterval(() => {
                    for (let i = 0; i < this.afflictions.length; i++) {
                        this.notifyPath(`afflictions.${i}.duration`);
                    }
                }, 1000);

                application.onGameLoaded(() => {
                    this._listen();
                });

                application.onRealmLoaded(realm => {
                    this.realm = realm;
                });

                if (this.compact) {
                    this.$['health-bar'].classList.add('health-bar-mini');
                    this.$.frame.classList.add('frame-mini');
                    this.$.portrait.classList.add('portrait-mini');
                    this.$.afflictions.classList.add('afflictions-mini');
                    this.$['class-icon'].classList.add('class-icon-mini');
                    this.style.width = '276px';
                }
            }

            _target() {
                game.publish('character-target', this.target);
            }

            _integer(number) {
                return Math.round(number);
            }

            _listen() {
                game.subscribe('character-update', (creature) => {
                    if (creature.id === this.target.id) {
                        this._updatePlayerState(creature);
                    }
                });
            }

            _portrait() {
                if (this.target && this.realm && this.target.classId) {
                    return `${this.realm.resources}/gui/class/${this.target.classId}.svg`;
                } else {
                    //return 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                    return "";
                }
            }

            _notifyTargetChange(target) {
                if (target) {
                    this._updatePlayerState(target);
                }
            }

            _updatePlayerState(target) {
                this._default(target, 'experience');
                this._default(target, 'nextlevel');
                this._default(target, 'energy');

                this.target = target;

                if (target.afflictions) {
                    this.afflictions = [];
                    this.afflictions = target.afflictions;
                    this.notifyPath("afflictions");
                }

                this.notifyPath("target.classId");
                this.shadowRoot.querySelector('#stats').update(target);
            }


            _description(affliction) {
                return eval('`' + affliction.description + '`');
            }

            _default(target, attribute, def) {
                if (!target.stats) {
                    target.stats = {
                        health: 0,
                        maxhealth: 1,
                        energy: 0,
                        maxenergy: 1,
                        experience: 0,
                        nextlevel: 1
                    };
                }
                if (!target.stats[attribute]) {
                    target.stats[attribute] = (def) ? def : 0;
                }
            }
        }

        window.customElements.define(PlayerStatus.is, PlayerStatus);
    </script>
</dom-module>