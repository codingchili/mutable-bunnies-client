<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">

<dom-module id="world-designer">
    <link rel="import" href="../../style/theme.css" type="css">
    <link rel="import" href="../../style/style.css" type="css">
    <template>
        <style>
            .designer {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                left: 16px;
                display: block;
                padding-left: 8px;
                padding-right: 8px;
                height: 60%;
                width: 276px;
                z-index: 400;
            }

            .registry-item {
                width: 100%;
                position: relative;
            }

            .registry-item:hover {
                background-color: #323232;
                cursor: pointer;
            }

            .item-icon-container {
                width: 64px;
                height: 64px;
                display: inline-flex;
                flex-direction: column;
            }

            .item-icon {
                max-width: 64px;
                max-height: 64px;
                margin: auto;
                text-align: center;
            }

            .item-title {
                position: absolute;
                left: 82px;
                margin-top: 8px;
            }

            .item-description {
                opacity: 0.76;
                font-size: smaller;
                left: 82px;
                position: absolute;
                margin-top: 26px;
                margin-right: 6px;
            }

            #registry-items {
                margin-top: 16px;
                max-height: 85%;
                overflow-y: scroll;
            }
        </style>

        <paper-material elevation="3" class="interface-box noselect designer">
            <paper-input value="{{filter}}" id="query" label="Search filter" on-input="_filter"
                         type="text" class="filter-input" always-float-label></paper-input>

            <div id="registry-items">
                <template is="dom-repeat" items="[[_registry(filter, registry)]]" as="item">
                    <div class="registry-item" on-click="_select">
                        <div class="item-icon-container">
                            <img src="[[realm.resources]]/[[item.model.graphics]]" class="item-icon">
                        </div>
                        <span class="item-title">[[item.name]]</span>
                        <span class="item-description">[[item.description]]</span>
                    </div>
                </template>
            </div>

            <div id="designer-tools">
                <div>
                    <!--<svg on-down="_characters" class="menu-icon">
                        <use href$="[[realm.resources]]gui/menu/leave.svg#root"></use>
                    </svg>
                    <paper-tooltip animation-delay="0" class="tooltip" position="left">
                        <span class="description">Leave [L]</span>
                    </paper-tooltip>-->
                </div>
            </div>
        </paper-material>

    </template>

    <script>
        class WorldDesigner extends Polymer.GestureEventListeners(Polymer.Element) {
            static get is() {
                return 'world-designer';
            }

            _registry() {
                return this.registry.filter(item => {
                    return this.filter.length === 0
                        || item.name.toLowerCase().includes(this.filter)
                        || item.description.toLowerCase().includes(this.filter);
                });
            }

            _select(e) {
                console.log(e.model.item);
                game.designer.load(e.model.item.id);
            }

            ready() {
                super.ready();
                this.registry = [];
                this.filter = "";

                //document.body.addEventListener('mousedown', this._spawn.bind(this));

                application.onRealmLoaded((realm) => {
                    this.realm = realm;
                });

                application.onGameLoaded((game) => {
                    input.onKeysListener({
                        down: (key) => {
                            if (key === input.LMB) {
                                game.designer.commit();
                            }
                            if (key === input.ESCAPE) {
                                game.designer.unload();
                            }
                        }
                    }, [input.LMB, input.ESCAPE]);

                    game.designer.registry((registry) => {
                        this.registry = registry.collection;
                    });
                });
            }
        }

        window.customElements.define(WorldDesigner.is, WorldDesigner);
    </script>
</dom-module>