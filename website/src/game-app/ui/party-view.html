<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="./player-status.html">

<!--
    @author Robin Duda
    Realm chat.
 -->

<dom-module id="party-view">
    <link rel="import" href="../../style/theme.css" type="css">
    <link rel="import" href="../../style/style.css" type="css">
    <template>
        <style>
            :host {
            }

            .container {
                position: absolute;
                top: 12%;
                left: 32px;
                display: flex;
                flex-direction: column;
                z-index: 400;
            }

            #dialog {
                min-height: 192px;
                min-width: 326px;
            }

            .member {
                position: relative;
                margin-bottom: 16px;
                top: 0;
                left: 0;
            }

            .invite-text {
                font-size: small;
                text-align: center;
                display: block;
                margin: 32px auto auto;
            }

            .response {
                display: flex;
                position: absolute;
                bottom: 0px;
                left: 0px;
                right: 0px;
            }

            .party-leave {
                display: block;
                position: absolute;
                left: -28px;
                top: -24px;
            }

        </style>

        <div class="dialog-container" id="container">
            <div class="dialog-overlay"></div>

            <paper-material elevation="3" class="interface-box noselect dialog-center" id="dialog">
                <iron-icon icon="icons:close" id="dialog-close" on-down="_decline"></iron-icon>

                <span class="dialog-entity">Party invite</span>

                <span class="invite-text">From [[invite.from]], do you accept? [[remaining]]s</span>

                <div class="response">
                    <paper-button on-tap="_decline">DECLINE</paper-button>
                    <paper-button primary raised on-tap="_accept">ACCEPT</paper-button>
                </div>
            </paper-material>

        </div>

        <div class="container">

            <template is="dom-if" if="[[_inParty(members)]]">
                <iron-icon icon="icons:close" class="party-leave" on-down="_leave"></iron-icon>
            </template>

            <template is="dom-repeat" items="[[members]]" as="member">
                <player-status target="[[_member(member, members)]]" class="member" style$="[[_index(index)]]"
                               compact>
                </player-status>
            </template>
        </div>

    </template>
    <script>
        class PartyView extends Polymer.GestureEventListeners(Polymer.Element) {

            static get is() {
                return 'party-view';
            }

            constructor() {
                super();
                this.invite = [];
                this.members = [];
                this.target = false;
                this.remaining = 0;
                this.INVITE_TIMEOUT = 29000; // ~30s.


                application.onRealmLoaded(realm => {
                    this.members = [];
                    this.realm = realm;
                });

                application.onGameLoaded((game) => {
                    this.account = application.token.domain;
                    this.game = game;
                    this._listen();
                });
            }

            _leave() {
                social.party_leave(() => {
                    this.members = [];
                    this._refresh();
                });
            }

            _inParty(members) {
                return members.length > 0;
            }

            _listen() {
                setInterval(() => {
                    if (this.remaining > 0) {
                        this.remaining -= 1;
                        this.notifyPath("remaining");
                    }
                }, 1000);

                this.game.subscribe('player-spawn', event => {
                    // update members when a player changes character.
                    if (this.members.includes(event.account) || event.account === this.account) {
                        this._refresh();
                    }
                });

                this.game.subscribe('player-leave', event => {
                    // set a placeholder when a player is connected but not in the game.
                    if (this.members.includes(event.account)) {
                        this._refresh();
                    }
                });

                server.connection.setHandler('party_invite', event => {
                    this.remaining = 30;
                    this.invite = event;
                    this._show();

                    setTimeout(() => {
                        if (this.invite.partyId === event.partyId) {
                            this._decline();
                        }
                    }, this.INVITE_TIMEOUT);
                });

                server.connection.setHandler('party_leave', event => {
                    this.members = this.members.filter(member => {
                        return member !== event.member;
                    });
                    this._refresh();
                });

                server.connection.setHandler('party_invite_response', event => {
                    if (event.accepted) {
                        this.members.push(event.from);
                        this._refresh();
                    } else {
                        game.chat.add({text: `${event.from} has declined the invite.`, party: true});
                    }
                });
            }

            _refresh() {
                let tmp = this.members;
                this.members = [];
                this.members = tmp;
                this.notifySplices('members', this.members.splice());
                this.notifyPath('members');
            }

            _member(account) {
                let entity = this.game.getByAccount(account);
                if (!entity) {
                    return {
                        name: account,
                        classId: 'placeholder',
                        stats: {
                            energy: 0,
                            maxenergy: 1,
                            health: 0,
                            maxhealth: 1,
                            nextlevel: 1,
                            experience: 0
                        }
                    };
                }
                return entity;
            }

            _accept() {
                social.party_accept(event => {
                    social.party_list(event => {
                        this.members = [];
                        for (let member of event.members) {
                            if (member !== application.token.domain) {
                                this.members.push(member);
                            }
                            this._refresh();
                        }
                    });

                }, this.invite.partyId);
                this._hide();
            }

            _decline() {
                social.party_decline(event => {
                    this.invite = {};
                }, this.invite.partyId);
                this._hide();
            }

            _show() {
                this.$.container.style.display = 'block';
                input.block();
            }

            _hide() {
                this.$.container.style.display = 'none';
                input.unblock();
            }

            _index(index) {
                return `z-index: ${10 - index};`;
            }

            _loaded() {
                return (typeof this.realm !== 'undefined');
            }

            _inventory() {
                application.publish('show-inventory');
            }

            _quests() {
                application.publish('show-quests');
            }

            _settings() {
                application.publish('show-settings');
            }

            _characters(e) {
                game.shutdown();
                application.scriptShutdown();
                application.showCharacters();
            }
        }

        window.customElements.define(PartyView.is, PartyView);
    </script>
</dom-module>