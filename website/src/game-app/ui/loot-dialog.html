<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../stats-view.html">
<link rel="import" href="inventory-item.html">

<!--
    @author Robin Duda
    Realm chat.
 -->

<dom-module id="loot-dialog">
    <link rel="import" href="../../style/theme.css" type="css">
    <link rel="import" href="../../style/style.css" type="css">
    <template>
        <style>
            :host {
            }

            #dialog {
                max-width: 428px;
                min-height: 112px;
                min-width: 428px;
            }

            span {
                padding: 0.28rem;
            }

            #loot-items {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
        </style>

        <div class="dialog-container" id="container">
            <div class="dialog-overlay"></div>

            <paper-material elevation="3" class="interface-box noselect dialog-center" id="dialog">
                <iron-icon icon="icons:close" id="dialog-close" on-down="_stop"></iron-icon>

                <span class="dialog-entity">[[target.name]]</span>

                <div id="loot-items">
                    <template is="dom-repeat" items="[[loot]]" as="item">
                        <div on-click="_loot">
                            <inventory-item item="[[item]]"></inventory-item>
                        </div>
                    </template>
                </div>
            </paper-material>
        </div>
    </template>
    <script>
        class LootDialog extends Polymer.GestureEventListeners(Polymer.Element) {

            static get is() {
                return 'loot-dialog';
            }

            ready() {
                super.ready();

                application.onGameLoaded(() => {
                    server.connection.setHandler('loot_list', {
                        accepted: (e) => {
                            this.set('target', game.entities[e.targetId]);
                            this.set('loot', e.lootList);

                            if (e.lootList.length > 0) {
                                this._start();
                            } else {
                                this._stop();
                            }
                        },
                        error: (event) => {
                            application.publish('notification', event.message);
                        }
                    });
                });

                application.onRealmLoaded((realm) => {
                    this.realm = realm;
                })
            }

            _loot(e) {
                game.inventory.takeLoot(this.target, e.model.item);
            }

            _start() {
                this.$.container.style.display = 'block';
                input.block();
            }

            _stop() {
                this.$.container.style.display = 'none';
                game.inventory.unsubscribeLootList(this.target);
                input.unblock();
            }
        }

        window.customElements.define(LootDialog.is, LootDialog);
    </script>
</dom-module>